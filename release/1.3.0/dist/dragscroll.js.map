{"version":3,"file":"dragscroll.js","sources":["../src/DragScroll.ts"],"sourcesContent":["import EventEmitter from \"@scena/event-emitter\";\nimport { isFunction, isString, now } from \"@daybrush/utils\";\nimport { CheckScrollOptions, DragScrollEvents, DragScrollOptions, Rect } from \"./types\";\n\nfunction getDefaultScrollPosition(e: { container: HTMLElement, direction: number[] }) {\n    let container = e.container;\n\n    if (container === document.body) {\n        return [\n            container.scrollLeft || document.documentElement.scrollLeft,\n            container.scrollTop || document.documentElement.scrollTop,\n        ];\n    }\n    return [\n        container.scrollLeft,\n        container.scrollTop,\n    ];\n}\n\nfunction getContainerElement(container: DragScrollOptions[\"container\"]): HTMLElement {\n    if (!container) {\n        return null;\n    } else if (isString(container)) {\n        return document.querySelector<HTMLElement>(container);\n    } if (isFunction(container)) {\n        return container();\n    } else if (container instanceof Element) {\n        return container;\n    } else if (\"current\" in container) {\n        return container.current;\n    } else if (\"value\" in container) {\n        return container.value;\n    }\n}\n\n/**\n * @sort 1\n */\nclass DragScroll extends EventEmitter<DragScrollEvents> {\n    private _startRect: Rect | null = null;\n    private _startPos: number[] = [];\n    private _prevTime: number = 0;\n    private _timer: number = 0;\n    private _prevScrollPos: number[] = [0, 0];\n    private _isWait = false;\n    private _flag = false;\n    /**\n     */\n    public dragStart(e: any, options: DragScrollOptions) {\n        const container = getContainerElement(options.container);\n\n        if (!container) {\n            this._flag = false;\n            return;\n        }\n        let top = 0;\n        let left = 0;\n        let width = 0;\n        let height = 0;\n\n        if (container === document.body) {\n            width = window.innerWidth;\n            height = window.innerHeight;\n        } else {\n            const rect = container.getBoundingClientRect();\n\n            top = rect.top;\n            left = rect.left;\n            width = rect.width;\n            height = rect.height;\n        }\n\n        this._flag = true;\n        this._startPos = [e.clientX, e.clientY];\n        this._startRect = { top, left, width, height };\n        this._prevScrollPos = this._getScrollPosition([0, 0], options);\n    }\n    public drag(e: any, options: DragScrollOptions) {\n        clearTimeout(this._timer);\n        if (!this._flag) {\n            return;\n        }\n        const {\n            clientX,\n            clientY,\n        } = e;\n        const {\n            threshold = 0,\n        } = options;\n        const {\n            _startRect,\n            _startPos,\n        } = this;\n\n        const direction = [0, 0];\n\n        if (_startRect.top > clientY - threshold) {\n            if (_startPos[1] > _startRect.top || clientY < _startPos[1]) {\n                direction[1] = -1;\n            }\n        } else if (_startRect.top + _startRect.height < clientY + threshold) {\n            if (_startPos[1] < _startRect.top + _startRect.height || clientY > _startPos[1]) {\n                direction[1] = 1;\n            }\n        }\n        if (_startRect.left > clientX - threshold) {\n            if (_startPos[0] > _startRect.left || clientX < _startPos[0]) {\n                direction[0] = -1;\n            }\n        } else if (_startRect.left + _startRect.width < clientX + threshold) {\n            if (_startPos[0] < _startRect.left + _startRect.width || clientX > _startPos[0]) {\n                direction[0] = 1;\n            }\n        }\n\n        if (!direction[0] && !direction[1]) {\n            return false;\n        }\n        return this._continueDrag({\n            ...options,\n            direction,\n            inputEvent: e,\n            isDrag: true,\n        });\n    }\n    /**\n     */\n    public checkScroll(options: CheckScrollOptions) {\n        if (this._isWait) {\n            return false;\n        }\n        const {\n            prevScrollPos = this._prevScrollPos,\n            direction,\n            throttleTime = 0,\n            inputEvent,\n            isDrag,\n        } = options;\n        const nextScrollPos = this._getScrollPosition(direction || [0, 0], options);\n        const offsetX = nextScrollPos[0] - prevScrollPos[0];\n        const offsetY = nextScrollPos[1] - prevScrollPos[1];\n\n        const nextDirection = direction || [\n            offsetX ? Math.abs(offsetX) / offsetX : 0,\n            offsetY ? Math.abs(offsetY) / offsetY : 0,\n        ];\n        this._prevScrollPos = nextScrollPos;\n\n        if (!offsetX && !offsetY) {\n            return false;\n        }\n        /**\n         * @event DragScroll#move\n         */\n        this.trigger(\"move\", {\n            offsetX: nextDirection[0] ? offsetX : 0,\n            offsetY: nextDirection[1] ? offsetY : 0,\n            inputEvent,\n        });\n\n        if (throttleTime && isDrag) {\n            clearTimeout(this._timer);\n            this._timer = window.setTimeout(() => {\n                this._continueDrag(options);\n            }, throttleTime);\n        }\n        return true;\n    }\n    /**\n     */\n    public dragEnd() {\n        this._flag = false;\n        clearTimeout(this._timer);\n    }\n    private _getScrollPosition(direction: number[], options: DragScrollOptions) {\n        const {\n            container,\n            getScrollPosition = getDefaultScrollPosition,\n        } = options;\n        return getScrollPosition({ container: getContainerElement(container), direction });\n    }\n    private _continueDrag(options: CheckScrollOptions) {\n        const {\n            container,\n            direction,\n            throttleTime,\n            useScroll,\n            isDrag,\n            inputEvent,\n        } = options;\n\n        if (!this._flag || (isDrag && this._isWait)) {\n            return;\n        }\n        const nowTime = now();\n        const distTime = Math.max(throttleTime + this._prevTime - nowTime, 0);\n\n        if (distTime > 0) {\n            clearTimeout(this._timer);\n            this._timer = window.setTimeout(() => {\n                this._continueDrag(options);\n            }, distTime);\n\n            return false;\n        }\n\n        this._prevTime = nowTime;\n        const prevScrollPos = this._getScrollPosition(direction, options);\n\n        this._prevScrollPos = prevScrollPos;\n\n        if (isDrag) {\n            this._isWait = true;\n        }\n        const param = {\n            container: getContainerElement(container),\n            direction,\n            inputEvent,\n        };\n        options.requestScroll?.(param);\n        /**\n         * @event DragScroll#scroll\n         */\n        this.trigger(\"scroll\", param);\n\n        this._isWait = false;\n        return useScroll || this.checkScroll({\n            ...options,\n            prevScrollPos,\n            direction,\n            inputEvent,\n        });\n    }\n}\n\nexport default DragScroll;\n"],"names":["getDefaultScrollPosition","e","container","document","body","scrollLeft","documentElement","scrollTop","getContainerElement","isString","querySelector","isFunction","Element","current","value","__extends","_this","options","_flag","top","left","width","height","window","innerWidth","innerHeight","rect","getBoundingClientRect","_startPos","clientX","clientY","_startRect","_prevScrollPos","_getScrollPosition","clearTimeout","_timer","_a","threshold","_b","direction","_continueDrag","inputEvent","isDrag","_isWait","prevScrollPos","throttleTime","nextScrollPos","offsetX","offsetY","nextDirection","Math","abs","trigger","setTimeout","getScrollPosition","useScroll","nowTime","now","distTime","max","_prevTime","param","requestScroll","checkScroll","EventEmitter"],"mappings":"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"}